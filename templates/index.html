<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise SQL Query Assistant - OpenRouter AI</title>
    <!-- Using a common, clean font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Prism.js for SQL Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js" defer></script>

    <style>
        :root {
            --primary-bg: #f4f8fa;
            --container-bg: #ffffff;
            --header-bg: #005A9C;
            --sidebar-bg: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-light: #ffffff;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --error-color: #dc3545;
            --success-color: #28a745;
            --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            background: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        .app-header {
            background-color: var(--header-bg);
            padding: 15px 25px;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .app-header-title h1 {
            font-size: 1.6em;
            margin: 0;
            font-weight: 600;
        }

        .app-header-info {
            text-align: right;
            font-size: 0.85em;
        }

        .app-header-info div {
            margin-bottom: 3px;
            opacity: 0.9;
        }

        #tehran-time-display {
            font-weight: 500;
        }

        #api-status-text {
            font-weight: 500;
        }


        .app-main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .chat-area {
            flex: 3;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            overflow: hidden;
        }

        .chat-history-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: #fdfdfd;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            max-width: 80%;
            clear: both;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .message.user {
            background: var(--accent-color);
            color: var(--text-light);
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        .message.bot {
            background: #e9ecef;
            color: var(--text-primary);
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.8em;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .message.user .message-sender {
            color: rgba(255, 255, 255, 0.8);
        }

        .message.bot .message-sender {
            color: #555;
        }

        .message-timestamp {
            float: right;
            font-size: 0.75em;
            opacity: 0.7;
            margin-left: 10px;
        }

        .message-content {
            font-size: 0.95em;
        }

        .message-content .error-text {
            color: var(--error-color);
            font-weight: 500;
        }

        .message-content em {
            color: #6c757d;
            font-style: italic;
        }

        .message-content pre[class*="language-"] {
            background: #2d2d2d;
            padding: 1em;
            border-radius: 6px;
            overflow: auto;
            font-size: 0.9em;
            border: 1px solid #444;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-input-area textarea {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            min-height: 50px;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .chat-input-area textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .chat-input-area button {
            flex-shrink: 0;
            padding: 0 25px;
            font-size: 1em;
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .chat-input-area button:hover {
            background-color: var(--accent-hover);
        }

        .chat-input-area button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }

        .sidebar {
            flex: 1;
            padding: 20px;
            background-color: var(--sidebar-bg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .sidebar-section h3 {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }

        .sidebar-section p {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .sidebar-section .btn {
            display: block;
            width: 100%;
            margin-bottom: 12px;
            padding: 10px 15px;
            font-weight: 500;
        }

        .sidebar-section .btn:last-child {
            margin-bottom: 0;
        }

        .btn-sync {
            background-color: var(--success-color);
        }

        .btn-sync:hover {
            background-color: #1e7e34;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-test-api-small {
            font-size: 0.85em !important;
            padding: 6px 12px !important;
            background-color: #e9ecef !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border-color) !important;
            margin-top: 10px !important;
            font-weight: 400 !important;
        }

        .btn-test-api-small:hover {
            background-color: #ced4da !important;
        }


        #document-operation-status .status-message {
            font-size: 0.9em;
            margin-top: 15px;
            word-wrap: break-word;
        }

        #doc-preview-container .document-preview-area {
            font-size: 0.85em;
            max-height: 150px;
            background-color: #f1f3f5;
            border-color: #ced4da;
        }

        .stats-panel-content {
            padding: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: var(--primary-bg);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .loading-indicator {
            text-align: center;
            padding: 15px 0;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border-width: 3px;
            margin-bottom: 5px;
            display: inline-block;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-indicator p {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .chat-history-container::-webkit-scrollbar, .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history-container::-webkit-scrollbar-track, .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-history-container::-webkit-scrollbar-thumb, .sidebar::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .chat-history-container::-webkit-scrollbar-thumb:hover, .sidebar::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        @media (max-width: 992px) {
            .app-main-layout {
                flex-direction: column;
            }

            .chat-area {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .app-container {
                height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }

            .app-header {
                padding: 12px 15px;
            }

            .app-header-title h1 {
                font-size: 1.25em;
            }

            .app-header-info {
                font-size: 0.8em;
            }

            .app-main-layout {
                padding: 10px;
                gap: 10px;
            }

            .chat-area, .sidebar {
                padding: 10px;
            }

            .sidebar-section {
                padding: 15px;
            }

            .chat-history-container {
                height: calc(100vh - 280px);
            }
        }

    </style>
</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="app-header-title">
            <h1>Enterprise SQL Query Assistant</h1>
        </div>
        <div class="app-header-info">
            <div>üë§ User: {{ user_login }}</div>
            <div><span id="tehran-time-display">--:--:--</span> (Tehran Time)</div>
            <div>ü§ñ API: <span id="api-status-text">Initializing...</span></div>
        </div>
    </header>

    <main class="app-main-layout">
        <section class="chat-area">
            <div class="chat-history-container" id="chat-messages-container">
                <div class="message bot">
                    <div class="message-sender">SQL Assistant <span class="message-timestamp"
                                                                    id="initial-welcome-time"></span></div>
                    <div class="message-content">Welcome! I use the local 'extracted_edit_url.txt' as context. Update it
                        via the sidebar if needed, then ask for SQL queries.
                    </div>
                </div>
            </div>
            <div class="loading-indicator" id="chat-loading-spinner">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>
            <div class="chat-input-area">
                <textarea id="question-input-field" placeholder="Type your SQL query request... (Ctrl+Enter to send)"
                          disabled rows="2"></textarea>
                <button id="ask-question-button" onclick="handleAskQuestion()" disabled title="Send (Ctrl+Enter)">‚ûî
                </button>
            </div>
        </section>

        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>üìÑ Document Control</h3>
                <p>Source: <strong id="doc-source-display">Loading...</strong></p>
                <button class="btn btn-sync" onclick="handleSyncFromOneDrive()" id="sync-onedrive-button">üîÑ Sync &
                    Reload File
                </button>
                <p style="font-size:0.8em; margin-top:2px; color: var(--text-secondary);">Updates
                    'extracted_edit_url.txt' by running 'onedrive.py'.</p>

                <button class="btn btn-secondary" onclick="handleCheckStatus()" style="margin-top:10px;">‚ÑπÔ∏è Check
                    Current Status
                </button>
                <div id="document-operation-status"></div>
                <div id="doc-preview-container"></div>
            </div>

            <div class="sidebar-section">
                <h3>üìä Session Statistics</h3>
                <div class="stats-panel-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-queries">0</div>
                            <div class="stat-label">Queries</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-total-tokens">0</div>
                            <div class="stat-label">Total Tokens</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-doc-chars">0</div>
                            <div class="stat-label">Doc Chars</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-total-cost">$0.00</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-avg-cost">$0.00</div>
                            <div class="stat-label">Avg. Cost/Query</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-avg-time">0s</div>
                            <div class="stat-label">Avg. Time/Query</div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-test-api-small" onclick="handleTestAPI()"
                        style="margin-top: 15px; display: block; text-align:center;">Test API Connectivity
                </button>
            </div>
        </aside>
    </main>
</div>

<script>
    let isDocumentLoaded = false;
    const sessionActivityStats = {
        queries: 0,
        totalTokens: 0,
        totalCost: 0.0,
        documentChars: 0,
        totalResponseTimeMs: 0.0
    };

    // Cache DOM Elements
    const tehranTimeDisplay = document.getElementById('tehran-time-display');
    const apiStatusText = document.getElementById('api-status-text');
    const initialWelcomeTime = document.getElementById('initial-welcome-time');
    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatLoadingSpinner = document.getElementById('chat-loading-spinner');
    const questionInputField = document.getElementById('question-input-field');
    const askQuestionButton = document.getElementById('ask-question-button');
    const syncOneDriveButton = document.getElementById('sync-onedrive-button');
    const documentOperationStatus = document.getElementById('document-operation-status');
    const docPreviewContainer = document.getElementById('doc-preview-container');
    const docSourceDisplay = document.getElementById('doc-source-display');
    const statQueries = document.getElementById('stat-queries');
    const statTotalTokens = document.getElementById('stat-total-tokens');
    const statDocChars = document.getElementById('stat-doc-chars');
    const statTotalCost = document.getElementById('stat-total-cost');
    const statAvgCost = document.getElementById('stat-avg-cost');
    const statAvgTime = document.getElementById('stat-avg-time');


    function updateTehranTime() {
        if (tehranTimeDisplay) {
            try {
                const tehranTime = new Date().toLocaleTimeString("en-GB", {
                    timeZone: "Asia/Tehran",
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hourCycle: 'h23'
                });
                tehranTimeDisplay.textContent = tehranTime;
            } catch (e) {
                console.warn("Timezone Asia/Tehran not available for Intl.DateTimeFormat, using local time for display.", e);
                tehranTimeDisplay.textContent = new Date().toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            }
        }
    }

    function escapeHtml(unsafeText) {
        if (typeof unsafeText !== 'string') return unsafeText;
        return unsafeText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function showOpStatus(message, type = 'info') {
        documentOperationStatus.innerHTML = `<div class="status-message ${type}">${escapeHtml(message)}</div>`;
        if (type !== 'error' && type !== 'info') {
            setTimeout(() => {
                if (documentOperationStatus.innerHTML.includes(escapeHtml(message))) documentOperationStatus.innerHTML = '';
            }, 7000);
        }
    }

    function showChatLoading(isLoading) {
        chatLoadingSpinner.style.display = isLoading ? 'flex' : 'none';
    }

    function updateSessionStatsDisplay() {
        statQueries.textContent = sessionActivityStats.queries;
        statTotalTokens.textContent = sessionActivityStats.totalTokens.toLocaleString();
        statTotalCost.textContent = `$${sessionActivityStats.totalCost.toFixed(6)}`;
        statDocChars.textContent = sessionActivityStats.documentChars.toLocaleString();

        const avgCost = sessionActivityStats.queries > 0 ? (sessionActivityStats.totalCost / sessionActivityStats.queries) : 0;
        statAvgCost.textContent = `$${avgCost.toFixed(6)}`;

        const avgTimeInSeconds = sessionActivityStats.queries > 0 ? (sessionActivityStats.totalResponseTimeMs / sessionActivityStats.queries / 1000) : 0;
        statAvgTime.textContent = `${avgTimeInSeconds.toFixed(1)}s`;
    }

    function addChatMessage(text, senderIsUser = false, apiMeta = {}) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${senderIsUser ? 'user' : 'bot'}`;
        const messageTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        let messageContentHtml = '';
        const isApiError = !senderIsUser && apiMeta && typeof apiMeta.error === 'string';
        const sqlKeywordsRegex = /\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|JOIN|GRANT|REVOKE|WITH|VALUES|TABLE|VIEW|INDEX|DATABASE|PROCEDURE|FUNCTION)\b/i;
        const responseText = (typeof text === 'string') ? text : "";

        if (isApiError) {
            messageContentHtml = `<div class="error-text"><strong>Error:</strong> ${escapeHtml(responseText)}</div>`;
        } else if (!senderIsUser && apiMeta && apiMeta.success === true) {
            if (sqlKeywordsRegex.test(responseText)) {
                messageContentHtml = `<pre><code class="language-sql">${escapeHtml(responseText)}</code></pre>`;
            } else if (responseText.trim() === "" || responseText.trim() === "[API Call Successful but no message content in choices]") {
                messageContentHtml = `<em>[API returned an empty or non-substantive answer.]</em>`;
            } else {
                messageContentHtml = escapeHtml(responseText).replace(/\n/g, '<br>');
            }
        } else if (senderIsUser) {
            messageContentHtml = escapeHtml(responseText).replace(/\n/g, '<br>');
        } else {
            messageContentHtml = escapeHtml(responseText).replace(/\n/g, '<br>');
        }

        if (!senderIsUser && (apiMeta.success === true || isApiError)) {
            sessionActivityStats.queries++;
            if (apiMeta.duration_ms) {
                sessionActivityStats.totalResponseTimeMs += parseFloat(apiMeta.duration_ms) || 0;
            }
            if (apiMeta.usage && apiMeta.usage.query_cost) {
                sessionActivityStats.totalTokens += apiMeta.usage.total_tokens || 0;
                sessionActivityStats.totalCost += parseFloat(apiMeta.usage.query_cost) || 0.0;
            } else if (apiMeta.usage) {
                sessionActivityStats.totalTokens += apiMeta.usage.total_tokens || 0;
            }
            updateSessionStatsDisplay();
        }

        messageDiv.innerHTML = `
                <div class="message-sender">${senderIsUser ? 'You' : 'SQL Assistant'} <span class="message-timestamp">${messageTimestamp}</span></div>
                <div class="message-content">${messageContentHtml}</div>`;
        chatMessagesContainer.appendChild(messageDiv);
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

        if (!isApiError && !senderIsUser && apiMeta && apiMeta.success === true && sqlKeywordsRegex.test(responseText)) {
            const codeBlock = messageDiv.querySelector('code.language-sql');
            if (codeBlock && window.Prism) Prism.highlightElement(codeBlock);
        }
    }

    async function makeApiRequest(endpoint, method = 'GET', body = null) {
        const showSpinner = endpoint === '/ask_question' || endpoint === '/sync_onedrive_document';
        if (showSpinner) showChatLoading(true);
        const fullUrl = window.location.origin + endpoint; // Use absolute URL
        try {
            const opt = {method};
            if (body) {
                opt.headers = {'Content-Type': 'application/json'};
                opt.body = JSON.stringify(body);
            }
            const resp = await fetch(fullUrl, opt);  // Use fullUrl
            if (!resp.ok) {
                const errorText = await resp.text();
                throw new Error(`HTTP error ${resp.status}: ${errorText.substring(0, 150)}`);
            }
            return await resp.json();
        } catch (e) {
            console.error(`API ${fullUrl}:`, e); // Log fullUrl
            return {success: false, error: `Request failed: ${e.message}`};
        } finally {
            if (showSpinner) showChatLoading(false);
        }
    }

    async function handleTestAPI() {
        apiStatusText.textContent = 'üì° Testing...';
        const res = await makeApiRequest('/test_api');
        if (res.success) {
            apiStatusText.textContent = '‚úÖ Online';
            addChatMessage(`API Test OK: ${res.answer}`, false, {success: true, model_used: res.model_used});
        } else {
            apiStatusText.textContent = '‚ùå Error';
            addChatMessage(res.error || 'API Test Failed.', false, {
                error: (res.error || 'Unknown test API error'),
                success: false
            });
        }
    }

    async function handleSyncFromOneDrive() {
        showOpStatus('üîÑ Syncing from OneDrive... (running onedrive.py - this may take a moment)', 'info');
        docPreviewContainer.innerHTML = '';

        const result = await makeApiRequest('/sync_onedrive_document', 'POST');
        if (result.success) {
            addChatMessage(result.message || 'Document synced and reloaded.', false, {success: true});
        } else {
            addChatMessage(result.error || 'Failed to sync document from OneDrive.', false, {
                error: result.error,
                success: false
            });
        }
        updateDocumentStatusUI(result);
    }

    async function handleAskQuestion() {
        const q = questionInputField.value.trim();
        if (!q) {
            showOpStatus('Please enter your question.', 'error');
            return;
        }
        if (!isDocumentLoaded) {
            showOpStatus('No document is active. Please sync or check status.', 'error');
            return;
        }
        addChatMessage(q, true);
        questionInputField.value = '';
        const res = await makeApiRequest('/ask_question', 'POST', {question: q});
        addChatMessage(res.success ? res.answer : res.error, false, res);
    }

    function updateDocumentStatusUI(statusResult) {
        const characters = statusResult.characters || 0;
        const source = statusResult.source || "None";

        isDocumentLoaded = statusResult.loaded && characters > 0;
        sessionActivityStats.documentChars = characters;
        if (docSourceDisplay) docSourceDisplay.textContent = source;

        if (isDocumentLoaded) {
            if (docPreviewContainer && statusResult.preview) {
                docPreviewContainer.innerHTML = `<div class="document-preview-area"><strong>üìÑ Preview (${characters.toLocaleString()} chars):</strong><br>${escapeHtml(statusResult.preview)}</div>`;
            } else if (docPreviewContainer) {
                docPreviewContainer.innerHTML = '';
            }
            questionInputField.disabled = false;
            askQuestionButton.disabled = false;
        } else {
            if (docPreviewContainer) docPreviewContainer.innerHTML = '';
            questionInputField.disabled = true;
            askQuestionButton.disabled = true;
        }
        updateSessionStatsDisplay();
    }

    async function handleCheckStatus() {
        showOpStatus('üîÑ Checking document status...', 'info');
        const result = await makeApiRequest('/status');
        updateDocumentStatusUI(result);
        if (result.loaded) {
            showOpStatus(`Status: Document '${result.source}' is active (${(result.characters || 0).toLocaleString()} chars).`, 'info');
        } else {
            showOpStatus(`Status: No document is currently active. Please use "Sync & Reload File" if you have a 'onedrive.py' script configured.`, 'info');
        }
    }

    async function handleClearDocument() {
        addChatMessage("The 'Reset to Initial Local Doc' button was removed. Use 'Sync & Reload File' to refresh the document. If you wish to reset client-side statistics, refresh the page.", false, {success: true});
    }

    questionInputField.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            handleAskQuestion();
        }
    });

    window.onload = () => {
        updateTehranTime();
        setInterval(updateTehranTime, 1000);
        if (initialWelcomeTime) initialWelcomeTime.textContent = new Date().toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
        });
        updateSessionStatsDisplay();
        handleCheckStatus();
        setTimeout(handleTestAPI, 700);
    };
</script>
</body>
</html>
