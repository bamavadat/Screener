<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise AI Assistant - OpenRouter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-bg: #f4f8fa; --container-bg: #ffffff; --header-bg-start: #0061A7; --header-bg-end: #007bff;
            --sidebar-bg: #f8f9fa; --text-primary: #1d232a; --text-secondary: #5a6773; --text-light: #ffffff;
            --border-color: #e3e9ef; --accent-color: #007bff; --accent-hover: #0056b3; --error-color: #e74c3c;
            --success-color: #2ecc71; --warning-color: #f39c12; --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --border-radius: 10px; --box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-primary);
            line-height: 1.65; display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding: 20px;
        }
        .app-container {
            width: 100%; max-width: 1500px; background: var(--container-bg); border-radius: var(--border-radius);
            box-shadow: var(--box-shadow); overflow: hidden; display: flex; flex-direction: column;
            height: calc(100vh - 40px);
        }
        .app-header {
            background-image: linear-gradient(135deg, var(--header-bg-start) 0%, var(--header-bg-end) 100%);
            padding: 18px 30px; color: var(--text-light); display: flex; justify-content: space-between;
            align-items: center; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .app-header h1 { font-size: 1.75em; margin: 0; font-weight: 600; letter-spacing: -0.5px; }
        .app-header-info { text-align: right; font-size: 0.9em; }
        .app-header-info div { margin-bottom: 4px; opacity: 0.95; }

        .app-main-layout { display: flex; flex-grow: 1; overflow: hidden; }
        .main-content-area {
            flex: 3; display: flex; flex-direction: column; padding: 0px 20px 20px 20px;
            border-right: 1px solid var(--border-color); overflow: hidden;
        }
        .tabs-nav {
            display: flex; border-bottom: 1px solid var(--border-color); padding: 0 20px;
            flex-shrink: 0; background-color: #fbfcfd;
        }
        .tab-button {
            padding: 14px 20px; cursor: pointer; border: none; border-bottom: 3px solid transparent;
            background-color: transparent; color: var(--text-secondary); font-size: 0.95em;
            font-weight: 500; margin-right: 10px; transition: color 0.2s ease, border-color 0.2s ease;
        }
        .tab-button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .tab-button:hover:not(.active) { color: var(--text-primary); }

        .tab-content { display: none; flex-grow: 1; overflow: hidden; flex-direction: column; padding-top: 20px; }
        .tab-content.active { display: flex; }

        .chat-interaction-wrapper { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .chat-history-container {
            flex-grow: 1; overflow-y: auto; padding: 20px; background-color: var(--primary-bg);
            border-radius: var(--border-radius); margin-bottom: 15px; border: 1px solid var(--border-color);
        }
        .message {
            margin-bottom: 18px; padding: 12px 18px; padding-bottom: 38px; border-radius: var(--border-radius);
            max-width: 80%; clear: both; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.06);
            position: relative;
        }
        .message.user { background: var(--accent-color); color: var(--text-light); margin-left: auto; }
        .message.bot { background: var(--container-bg); border: 1px solid var(--border-color); color: var(--text-primary); margin-right: auto; }
        .message-sender { font-weight: 600; font-size: 0.8em; margin-bottom: 6px; color: var(--text-secondary); }
        .message.user .message-sender { color: rgba(255,255,255,0.8); }
        .message-timestamp { float: right; font-size: 0.75em; opacity: 0.7; margin-left: 10px; }

        .message-actions {
            position: absolute; bottom: 6px; right: 8px; display: flex; gap: 8px;
            opacity: 0; transition: opacity 0.2s ease-in-out;
        }
        .message:hover .message-actions { opacity: 1; }
        .message-action-button {
            background: rgba(0,0,0,0.05); border: none; color: var(--text-secondary); padding: 4px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; transition: background-color 0.2s;
        }
        .message-action-button svg { width: 14px; height: 14px; fill: currentColor; }
        .message.user .message-action-button { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }

        .message-content { font-size: 0.95em; margin-top: 5px; }
        .message-content .error-text { color: var(--error-color); font-weight: 500; }
        .message-content em { color: #6c757d; font-style: italic; }
        .message-content pre[class*="language-sql"] { background: #2d2d2d; padding: 1em; border-radius: 6px; overflow: auto; font-size: 0.9em; }

        .chat-input-area { display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .chat-input-area textarea {
            flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius); font-size: 1em; min-height: 50px; resize: vertical;
            max-height: 150px; font-family: inherit;
        }
        .chat-input-area textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); }
        .chat-input-area button {
            flex-shrink: 0; padding: 0 25px; font-size: 1em; background-color: var(--accent-color);
            color: var(--text-light); border: none; border-radius: var(--border-radius);
            cursor: pointer; transition: background-color 0.3s;
        }
        .chat-input-area button:hover { background-color: var(--accent-hover); }
        .chat-input-area button:disabled { background-color: #adb5bd; cursor: not-allowed; }

        /* Enhanced Status Indicator */
        .status-indicator {
            display: none; padding: 12px 20px; margin-bottom: 10px; border-radius: var(--border-radius);
            border-left: 4px solid; font-size: 0.9em; position: relative; overflow: hidden;
        }
        .status-indicator.active { display: block; }
        .status-indicator.connecting { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
        .status-indicator.waiting { background: #fff3e0; border-color: var(--warning-color); color: #e65100; }
        .status-indicator.streaming { background: #e8f5e8; border-color: var(--success-color); color: #2e7d32; }
        .status-indicator.error { background: #ffebee; border-color: var(--error-color); color: #c62828; }
        .status-indicator.timeout { background: #fce4ec; border-color: #e91e63; color: #ad1457; }

        .status-indicator .status-icon {
            display: inline-block; margin-right: 8px; font-weight: bold;
        }

        .status-indicator .status-details {
            display: block; font-size: 0.8em; opacity: 0.8; margin-top: 4px;
        }

        .status-indicator .progress-bar {
            position: absolute; bottom: 0; left: 0; height: 3px; background: currentColor;
            opacity: 0.3; transition: width 0.3s ease;
        }

        .status-indicator.streaming .progress-bar {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        .sidebar {
            flex: 1; padding: 20px; background-color: var(--sidebar-bg); overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
        }
        .sidebar-section {
            background-color: var(--container-bg); padding: 20px; border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .sidebar-section h3 {
            font-size: 1.1em; color: var(--text-primary); margin-bottom: 15px;
            padding-bottom: 10px; border-bottom: 1px solid var(--border-color); font-weight: 600;
        }
        .sidebar-section p { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; }
        .btn {
            display: block; width: 100%; margin-bottom: 12px; padding: 10px 15px;
            font-weight: 500; border: none; border-radius: var(--border-radius);
            cursor: pointer; color: white;
        }
        .btn-sync { background-color: var(--success-color); }
        .btn-sync:hover { background-color: #1e7e34; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-test-api-small {
            font-size: 0.85em !important; padding: 6px 12px !important;
            background-color: #e9ecef !important; color: var(--text-secondary) !important;
            border: 1px solid var(--border-color) !important;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .stat-item { background: var(--primary-bg); padding: 10px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1.2em; font-weight: 600; color: var(--accent-color); }
        .stat-label { font-size: 0.75em; color: var(--text-secondary); }

        .loading-indicator {
            text-align: center; padding: 10px 0; display: none; justify-content: center;
            align-items: center; flex-direction: column;
        }
        .spinner {
            width: 18px; height: 18px; border: 3px solid rgba(0,0,0,0.1);
            border-top-color: var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 3px;
        }

        .recent-questions-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .recent-questions-list { list-style: none; padding: 0; max-height: 120px; overflow-y: auto; }
        .recent-questions-list li {
            padding: 6px 10px; margin-bottom: 4px; background-color: #f1f3f5;
            border: 1px solid #e7eaed; border-radius: 4px; cursor: pointer;
            font-size: 0.85em; transition: background-color 0.2s; overflow: hidden;
            text-overflow: ellipsis; white-space: nowrap;
        }
        .recent-questions-list li:hover { background-color: #e2e6ea; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 992px) {
            .app-main-layout { flex-direction: column; }
            .main-content-area { border-right: none; border-bottom: 1px solid var(--border-color); }
        }
        @media (max-width: 768px) {
            body { padding: 0; }
            .app-container { height: 100vh; border-radius: 0; box-shadow: none; }
            .app-header { padding: 12px 15px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div><h1>Enterprise AI Assistant</h1></div>
            <div class="app-header-info">
                <div>üë§ User: bamavadat</div>
                <div><span id="tehran-time">--:--:--</span> (Tehran Time)</div>
                <div>ü§ñ API: <span id="api-status">Initializing...</span></div>
            </div>
        </header>

        <main class="app-main-layout">
            <div class="main-content-area">
                <nav class="tabs-nav">
                    <button class="tab-button active" onclick="openTab(event, 'sqlTab')">SQL Query Bot</button>
                    <button class="tab-button" onclick="openTab(event, 'generalTab')">General Chat</button>
                </nav>

                <div id="sqlTab" class="tab-content active">
                    <div class="chat-interaction-wrapper">
                        <!-- Enhanced Status Indicator -->
                        <div id="sql-status" class="status-indicator">
                            <span class="status-icon">üîÑ</span>
                            <span class="status-text">Ready</span>
                            <div class="status-details"></div>
                            <div class="progress-bar"></div>
                        </div>

                        <div class="chat-history-container" id="sql-messages">
                            <div class="message bot">
                                <div class="message-sender">SQL Assistant <span class="message-timestamp" id="sql-welcome-time"></span></div>
                                <div class="message-content">SQL Bot ready. I use the local 'extracted_edit_url.txt' for context.</div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <textarea id="sql-input" placeholder="Type your SQL query request here... (Ctrl+Enter to send)" disabled></textarea>
                            <button id="sql-button" onclick="handleSQLQuestion()" disabled>‚ûî</button>
                        </div>
                        <div class="recent-questions-section">
                            <h4>Recent SQL Queries:</h4>
                            <ul id="sql-recent" class="recent-questions-list"></ul>
                        </div>
                    </div>
                </div>

                <div id="generalTab" class="tab-content">
                    <div class="chat-interaction-wrapper">
                        <!-- Enhanced Status Indicator -->
                        <div id="general-status" class="status-indicator">
                            <span class="status-icon">üîÑ</span>
                            <span class="status-text">Ready</span>
                            <div class="status-details"></div>
                            <div class="progress-bar"></div>
                        </div>

                        <div class="chat-history-container" id="general-messages">
                            <div class="message bot">
                                <div class="message-sender">General Assistant <span class="message-timestamp" id="general-welcome-time"></span></div>
                                <div class="message-content">Hello! I'm ready for a general conversation. Ask me anything!</div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <textarea id="general-input" placeholder="Type your message here... (Ctrl+Enter to send)"></textarea>
                            <button id="general-button" onclick="handleGeneralChat()">‚ûî</button>
                        </div>
                        <div class="recent-questions-section">
                            <h4>Recent General Messages:</h4>
                            <ul id="general-recent" class="recent-questions-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="sidebar">
                <div class="sidebar-section" id="doc-section">
                    <h3>üìÑ Document Control <small>(SQL Bot)</small></h3>
                    <p>Source: <strong id="doc-source">Loading...</strong></p>
                    <button class="btn btn-sync" onclick="handleSync()">üîÑ Sync & Reload File</button>
                    <p style="font-size:0.8em; margin-top:2px; color: var(--text-secondary);">Updates 'extracted_edit_url.txt'.</p>
                    <button class="btn btn-secondary" onclick="handleStatus()">‚ÑπÔ∏è Check Status</button>
                    <div id="doc-status"></div>
                    <div id="doc-preview"></div>
                </div>

                <div class="sidebar-section" id="sql-stats-section">
                    <h3>üìä SQL Bot Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="stat-value" id="sql-queries">0</div><div class="stat-label">Queries</div></div>
                        <div class="stat-item"><div class="stat-value" id="sql-tokens">0</div><div class="stat-label">Tokens</div></div>
                        <div class="stat-item"><div class="stat-value" id="sql-chars">0</div><div class="stat-label">Doc Chars</div></div>
                        <div class="stat-item"><div class="stat-value" id="sql-cost">$0.00</div><div class="stat-label">Cost</div></div>
                        <div class="stat-item"><div class="stat-value" id="sql-avg-cost">$0.00</div><div class="stat-label">Avg. Cost</div></div>
                        <div class="stat-item"><div class="stat-value" id="sql-avg-time">0s</div><div class="stat-label">Avg. Time</div></div>
                    </div>
                </div>

                <div class="sidebar-section" id="general-stats-section">
                    <h3>üìä General Chat Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="stat-value" id="general-queries">0</div><div class="stat-label">Queries</div></div>
                        <div class="stat-item"><div class="stat-value" id="general-tokens">0</div><div class="stat-label">Tokens</div></div>
                        <div class="stat-item"><div class="stat-value" id="general-cost">$0.00</div><div class="stat-label">Cost</div></div>
                        <div class="stat-item"><div class="stat-value" id="general-avg-cost">$0.00</div><div class="stat-label">Avg. Cost</div></div>
                        <div class="stat-item"><div class="stat-value" id="general-avg-time">0s</div><div class="stat-label">Avg. Time</div></div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>‚öôÔ∏è Utilities</h3>
                    <button class="btn btn-test-api-small" onclick="handleTestAPI()">Test API Connectivity</button>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // Global variables and initialization
        let isInitialized = false;
        const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
        const editIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;

        const stats = {
            sql: { queries: 0, tokens: 0, cost: 0, chars: 0, time: 0, recent: [] },
            general: { queries: 0, tokens: 0, cost: 0, time: 0, recent: [] }
        };

        const history = { sql: [], general: [] };
        let isDocLoaded = false;

        // Status management
        function updateStatus(type, status, message, details = '', progress = 0) {
            const statusEl = document.getElementById(`${type}-status`);
            if (!statusEl) return;

            const iconEl = statusEl.querySelector('.status-icon');
            const textEl = statusEl.querySelector('.status-text');
            const detailsEl = statusEl.querySelector('.status-details');
            const progressEl = statusEl.querySelector('.progress-bar');

            // Remove all status classes
            statusEl.classList.remove('connecting', 'waiting', 'streaming', 'error', 'timeout');

            // Set status-specific content
            switch(status) {
                case 'ready':
                    statusEl.classList.remove('active');
                    break;
                case 'connecting':
                    statusEl.classList.add('active', 'connecting');
                    iconEl.textContent = 'üîó';
                    textEl.textContent = 'Connecting to API...';
                    break;
                case 'waiting':
                    statusEl.classList.add('active', 'waiting');
                    iconEl.textContent = '‚è≥';
                    textEl.textContent = 'Waiting for response...';
                    break;
                case 'streaming':
                    statusEl.classList.add('active', 'streaming');
                    iconEl.textContent = 'üì°';
                    textEl.textContent = 'Receiving response...';
                    break;
                case 'error':
                    statusEl.classList.add('active', 'error');
                    iconEl.textContent = '‚ùå';
                    textEl.textContent = 'API Error';
                    break;
                case 'timeout':
                    statusEl.classList.add('active', 'timeout');
                    iconEl.textContent = '‚è∞';
                    textEl.textContent = 'Request Timeout';
                    break;
                case 'no-content':
                    statusEl.classList.add('active', 'error');
                    iconEl.textContent = 'üì≠';
                    textEl.textContent = 'No Content Received';
                    break;
            }

            if (message) textEl.textContent = message;
            if (details) detailsEl.textContent = details;
            if (progress > 0) progressEl.style.width = `${progress}%`;

            // Auto-hide after delay for some statuses
            if (['error', 'timeout', 'no-content'].includes(status)) {
                setTimeout(() => statusEl.classList.remove('active'), 5000);
            }
        }

        // Initialize immediately when script loads
        function init() {
            if (isInitialized) return;
            isInitialized = true;

            console.log("Initializing app...");

            // Set welcome times
            const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            const sqlWelcome = document.getElementById('sql-welcome-time');
            const generalWelcome = document.getElementById('general-welcome-time');
            if (sqlWelcome) sqlWelcome.textContent = now;
            if (generalWelcome) generalWelcome.textContent = now;

            // Setup keyboard shortcuts
            const sqlInput = document.getElementById('sql-input');
            const generalInput = document.getElementById('general-input');

            if (sqlInput) {
                sqlInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); handleSQLQuestion(); }
                });
            }
            if (generalInput) {
                generalInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); handleGeneralChat(); }
                });
            }

            // Start periodic updates
            setInterval(updateTime, 1000);
            updateTime();
            updateStats();

            // Initialize app state
            setTimeout(() => {
                handleTestAPI();
                handleStatus();
            }, 100);

            console.log("App initialized");
        }

        // Call init immediately
        init();

        // Also call on DOM content loaded as backup
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        }

        function updateTime() {
            const timeEl = document.getElementById('tehran-time');
            if (timeEl) {
                try {
                    const t = new Date().toLocaleTimeString("en-GB", {
                        timeZone: "Asia/Tehran", hour: '2-digit', minute: '2-digit', second: '2-digit', hourCycle: 'h23'
                    });
                    timeEl.textContent = t;
                } catch (e) {
                    timeEl.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false});
                }
            }
        }

        function escape(t) {
            return typeof t === 'string' ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;") : t;
        }

        function showStatus(m, type = 'info') {
            const statusEl = document.getElementById('doc-status');
            if (statusEl) {
                statusEl.innerHTML = `<div class="status-message ${type}" style="font-size:0.9em;margin-top:15px;word-wrap:break-word;">${escape(m)}</div>`;
                if (type !== 'error' && type !== 'info') {
                    setTimeout(() => { if (statusEl && statusEl.innerHTML.includes(escape(m))) statusEl.innerHTML = ''; }, 5000);
                }
            }
        }

        function updateStats() {
            const elements = {
                sqlQueries: document.getElementById('sql-queries'),
                sqlTokens: document.getElementById('sql-tokens'),
                sqlChars: document.getElementById('sql-chars'),
                sqlCost: document.getElementById('sql-cost'),
                sqlAvgCost: document.getElementById('sql-avg-cost'),
                sqlAvgTime: document.getElementById('sql-avg-time'),
                generalQueries: document.getElementById('general-queries'),
                generalTokens: document.getElementById('general-tokens'),
                generalCost: document.getElementById('general-cost'),
                generalAvgCost: document.getElementById('general-avg-cost'),
                generalAvgTime: document.getElementById('general-avg-time')
            };

            if (elements.sqlQueries) elements.sqlQueries.textContent = stats.sql.queries;
            if (elements.sqlTokens) elements.sqlTokens.textContent = stats.sql.tokens.toLocaleString();
            if (elements.sqlChars) elements.sqlChars.textContent = stats.sql.chars.toLocaleString();
            if (elements.sqlCost) elements.sqlCost.textContent = `$${stats.sql.cost.toFixed(6)}`;
            if (elements.sqlAvgCost) elements.sqlAvgCost.textContent = `$${(stats.sql.queries > 0 ? stats.sql.cost / stats.sql.queries : 0).toFixed(6)}`;
            if (elements.sqlAvgTime) elements.sqlAvgTime.textContent = `${(stats.sql.queries > 0 ? stats.sql.time / stats.sql.queries / 1000 : 0).toFixed(1)}s`;

            if (elements.generalQueries) elements.generalQueries.textContent = stats.general.queries;
            if (elements.generalTokens) elements.generalTokens.textContent = stats.general.tokens.toLocaleString();
            if (elements.generalCost) elements.generalCost.textContent = `$${stats.general.cost.toFixed(6)}`;
            if (elements.generalAvgCost) elements.generalAvgCost.textContent = `$${(stats.general.queries > 0 ? stats.general.cost / stats.general.queries : 0).toFixed(6)}`;
            if (elements.generalAvgTime) elements.generalAvgTime.textContent = `${(stats.general.queries > 0 ? stats.general.time / stats.general.queries / 1000 : 0).toFixed(1)}s`;
        }

        // Tab management
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => { tc.style.display = 'none'; tc.classList.remove('active'); });
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            const tab = document.getElementById(tabName);
            if (tab) {
                tab.style.display = 'flex';
                tab.classList.add('active');
            }
            evt.currentTarget.classList.add('active');

            const docSection = document.getElementById('doc-section');
            const sqlStatsSection = document.getElementById('sql-stats-section');
            const generalStatsSection = document.getElementById('general-stats-section');

            if (tabName === 'sqlTab') {
                if (docSection) docSection.style.display = 'block';
                if (sqlStatsSection) sqlStatsSection.style.display = 'block';
                if (generalStatsSection) generalStatsSection.style.display = 'none';
            } else if (tabName === 'generalTab') {
                if (docSection) docSection.style.display = 'none';
                if (sqlStatsSection) sqlStatsSection.style.display = 'none';
                if (generalStatsSection) generalStatsSection.style.display = 'block';
            }
        }

        // API functions
        async function handleTestAPI() {
            const apiStatus = document.getElementById('api-status');
            if (!apiStatus) return;

            apiStatus.textContent = 'üì° Testing...';

            try {
                const res = await fetch('/test_api');
                const data = await res.json();
                apiStatus.textContent = data.success ? '‚úÖ Online' : '‚ùå Error';
                console.log("API test result:", data);
            } catch (e) {
                apiStatus.textContent = '‚ùå Failed';
                showStatus(`API test failed: ${e.message}`, 'error');
                console.error("API test error:", e);
            }
        }

        async function handleStatus() {
            showStatus('üîÑ Checking status...', 'info');

            try {
                const res = await fetch('/status');
                const data = await res.json();
                updateDocStatus(data);
                showStatus(`Status: ${data.loaded ? `Document active (${data.characters?.toLocaleString()} chars)` : 'No document'}`, 'info');

                const generalInput = document.getElementById('general-input');
                const generalButton = document.getElementById('general-button');
                if (generalInput) generalInput.disabled = false;
                if (generalButton) generalButton.disabled = false;

                console.log("Status check result:", data);
            } catch (e) {
                showStatus(`Status check failed: ${e.message}`, 'error');
                const apiStatus = document.getElementById('api-status');
                if (apiStatus) apiStatus.textContent = '‚ùå Error';
                console.error("Status check error:", e);
            }
        }

        async function handleSync() {
            showStatus('üîÑ Syncing...', 'info');
            const docPreview = document.getElementById('doc-preview');
            if (docPreview) docPreview.innerHTML = '';

            try {
                const res = await fetch('/sync_onedrive_document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success !== false) {
                    const sqlMessages = document.getElementById('sql-messages');
                    if (sqlMessages) addMessage(sqlMessages, data.message || 'Document synced.', false, {success: true});
                    updateDocStatus(data);
                    showStatus('Sync completed', 'success');
                } else {
                    const sqlMessages = document.getElementById('sql-messages');
                    if (sqlMessages) addMessage(sqlMessages, data.error || 'Sync failed.', false, {error: data.error});
                    showStatus(`Sync failed: ${data.error}`, 'error');
                }
                console.log("Sync result:", data);
            } catch (e) {
                showStatus(`Sync failed: ${e.message}`, 'error');
                const sqlMessages = document.getElementById('sql-messages');
                if (sqlMessages) addMessage(sqlMessages, `Sync failed: ${e.message}`, false, {error: e.message});
                console.error("Sync error:", e);
            }
        }

        function updateDocStatus(data) {
            const chars = data.characters || 0;
            const source = data.source || "None";
            isDocLoaded = data.loaded && chars > 0;
            stats.sql.chars = chars;

            const docSource = document.getElementById('doc-source');
            if (docSource) docSource.textContent = source;

            const sqlInput = document.getElementById('sql-input');
            const sqlButton = document.getElementById('sql-button');
            const docPreview = document.getElementById('doc-preview');

            if (isDocLoaded) {
                if (docPreview && data.preview) {
                    docPreview.innerHTML = `<div style="font-size:0.85em;max-height:150px;background:#f1f3f5;padding:10px;border-radius:6px;border:1px solid var(--border-color);overflow-y:auto;"><strong>üìÑ Preview (${chars.toLocaleString()} chars):</strong><br>${escape(data.preview)}</div>`;
                }
                if (sqlInput) sqlInput.disabled = false;
                if (sqlButton) sqlButton.disabled = false;
            } else {
                if (docPreview) docPreview.innerHTML = '';
                if (sqlInput) sqlInput.disabled = true;
                if (sqlButton) sqlButton.disabled = true;
            }
            updateStats();
        }

        // Message functions
        function addMessage(container, text, isUser = false, meta = {}, isPlaceholder = false) {
            const msg = document.createElement('div');
            msg.className = `message ${isUser ? 'user' : 'bot'}`;
            msg.dataset.originalText = text;
            msg.id = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isError = !isUser && meta.error;
            const sqlRegex = /\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|JOIN)\b/i;

            let content = '';
            if (isError) {
                content = `<div class="error-text"><strong>Error:</strong> ${escape(text)}</div>`;
            } else if (!isUser && meta.success) {
                if (isPlaceholder) {
                    content = `<em>${container.id === 'sql-messages' ? 'SQL Assistant' : 'General Assistant'} is typing...</em>`;
                } else if (container.id === 'sql-messages' && sqlRegex.test(text)) {
                    content = `<pre><code class="language-sql">${escape(text)}</code></pre>`;
                } else if (!text.trim()) {
                    content = `<em>[API returned empty response.]</em>`;
                } else {
                    content = typeof marked === 'function' && container.id === 'general-messages' ?
                        marked.parse(text, { breaks: true, gfm: true }) : escape(text).replace(/\n/g, '<br>');
                }
            } else {
                content = escape(text).replace(/\n/g, '<br>');
            }

            // Add actions for bot messages with content and user messages
            let actions = '<div class="message-actions">';
            if (!isUser && !isError && !isPlaceholder && text && text.trim() && meta.success) {
                actions += `<button class="message-action-button" title="Copy" onclick="copyMessage(this)">${copyIcon}</button>`;
            }
            if (isUser) {
                actions += `<button class="message-action-button" title="Edit" onclick="editMessage(this.closest('.message'))">${editIcon}</button>`;
            }
            actions += '</div>';

            msg.innerHTML = `
                <div class="message-sender">${isUser ? 'You' : (container.id === 'sql-messages' ? 'SQL Assistant' : 'General Assistant')}
                <span class="message-timestamp">${timestamp}</span></div>
                <div class="message-content">${content}</div>
                ${actions}`;

            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;

            if (!isError && !isPlaceholder && !isUser && meta.success && container.id === 'sql-messages' && sqlRegex.test(text)) {
                const code = msg.querySelector('code.language-sql');
                if (code && window.Prism) Prism.highlightElement(code);
            }

            return msg.id;
        }

        function copyMessage(btn) {
            const msg = btn.closest('.message');
            const text = msg.dataset.originalText;
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    showStatus("Copied to clipboard!", "success");
                    // Visual feedback
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úì';
                    btn.style.background = 'var(--success-color)';
                    btn.style.color = 'white';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 1000);
                }).catch(() => {
                    showStatus("Copy failed", "error");
                });
            }
        }

        function editMessage(msg) {
            console.log("Edit message:", msg);
            // Edit functionality can be implemented here
        }

        // Chat handlers
        async function handleSQLQuestion() {
            const input = document.getElementById('sql-input');
            if (!input) return;

            const text = input.value.trim();
            if (!text) return;

            const container = document.getElementById('sql-messages');
            const type = 'sql';

            if (container) {
                addMessage(container, text, true);
                history.sql.push({role: "user", content: text});
            }

            input.value = '';
            stats.sql.recent.unshift(text);
            if (stats.sql.recent.length > 5) stats.sql.recent.pop();
            updateRecent('sql');

            await streamRequest('/stream_sql_query', {messages: history.sql}, container, stats.sql, history.sql, type);
        }

        async function handleGeneralChat() {
            const input = document.getElementById('general-input');
            if (!input) return;

            const text = input.value.trim();
            if (!text) return;

            const container = document.getElementById('general-messages');
            const type = 'general';

            if (container) {
                addMessage(container, text, true);
                history.general.push({role: "user", content: text});
            }

            input.value = '';
            stats.general.recent.unshift(text);
            if (stats.general.recent.length > 5) stats.general.recent.pop();
            updateRecent('general');

            await streamRequest('/stream_general_chat', {messages: history.general}, container, stats.general, history.general, type);
        }

        async function streamRequest(endpoint, body, container, statsObj, historyArray, type) {
            if (!container) {
                console.error("No container provided for stream request");
                return;
            }

            updateStatus(type, 'connecting', 'Connecting to API...', `Endpoint: ${endpoint}`);

            let msgId = addMessage(container, "", false, {success: true}, true);
            let response = "";
            let startTime = Date.now();
            let isStreamComplete = false;
            let timeoutWarningShown = false;

            // Timeout warning for Vercel limits
            const timeoutWarning = setTimeout(() => {
                if (!isStreamComplete) {
                    timeoutWarningShown = true;
                    updateStatus(type, 'timeout', 'Request taking longer than expected...',
                        'Vercel may timeout requests. Consider using a different deployment for very slow APIs.');
                }
            }, 45000); // 45 seconds warning for 60s limit

            try {
                console.log("Starting stream request to:", endpoint);
                updateStatus(type, 'waiting', 'Waiting for API response...', 'Request sent, waiting for first data...');

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    clearTimeout(timeoutWarning);
                    updateStatus(type, 'error', `HTTP Error ${res.status}`, res.statusText);
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                updateStatus(type, 'streaming', 'Receiving response...', 'Stream started');

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
                let firstChunk = false;
                let lastUpdateTime = Date.now();
                let chunkCount = 0;

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) {
                        console.log("Stream reading completed");
                        break;
                    }

                    chunkCount++;
                    buffer += decoder.decode(value, {stream: true});
                    let eventEndIndex;

                    while ((eventEndIndex = buffer.indexOf("\n\n")) >= 0) {
                        const event = buffer.substring(0, eventEndIndex);
                        buffer = buffer.substring(eventEndIndex + 2);

                        if (event.startsWith("data: ")) {
                            try {
                                const data = JSON.parse(event.substring(6));
                                const msgDiv = document.getElementById(msgId);

                                if (msgDiv) {
                                    const contentDiv = msgDiv.querySelector('.message-content');

                                    if (data.type === "content" && data.delta) {
                                        if (!firstChunk) {
                                            contentDiv.innerHTML = '';
                                            firstChunk = true;
                                            updateStatus(type, 'streaming', 'Streaming response...', 'First content received');
                                        }
                                        response += data.delta;

                                        // Throttle updates for better performance with large responses
                                        const now = Date.now();
                                        if (now - lastUpdateTime > 100) { // Update every 100ms max
                                            const sqlRegex = /\b(SELECT|INSERT|UPDATE|DELETE)\b/i;
                                            if (container.id === 'sql-messages' && sqlRegex.test(response)) {
                                                contentDiv.innerHTML = `<pre><code class="language-sql">${escape(response)}</code></pre>`;
                                                const code = contentDiv.querySelector('code.language-sql');
                                                if (code && window.Prism) Prism.highlightElement(code);
                                            } else if (container.id === 'general-messages' && typeof marked === 'function') {
                                                contentDiv.innerHTML = marked.parse(response, {breaks: true, gfm: true});
                                            } else {
                                                contentDiv.innerHTML = escape(response).replace(/\n/g, '<br>');
                                            }

                                            container.scrollTop = container.scrollHeight;
                                            lastUpdateTime = now;

                                            // Update status with progress
                                            updateStatus(type, 'streaming', 'Streaming response...',
                                                `${response.length} chars received (${chunkCount} chunks)`);
                                        }
                                    } else if (data.type === "done") {
                                        console.log("Received done signal from stream");
                                        isStreamComplete = true;
                                        clearTimeout(timeoutWarning);

                                        // Final update with complete response
                                        const sqlRegex = /\b(SELECT|INSERT|UPDATE|DELETE)\b/i;
                                        if (container.id === 'sql-messages' && sqlRegex.test(response)) {
                                            contentDiv.innerHTML = `<pre><code class="language-sql">${escape(response)}</code></pre>`;
                                            const code = contentDiv.querySelector('code.language-sql');
                                            if (code && window.Prism) Prism.highlightElement(code);
                                        } else if (container.id === 'general-messages' && typeof marked === 'function') {
                                            contentDiv.innerHTML = marked.parse(response, {breaks: true, gfm: true});
                                        } else {
                                            contentDiv.innerHTML = escape(response).replace(/\n/g, '<br>');
                                        }

                                        msgDiv.dataset.originalText = response;
                                        if (historyArray && response) historyArray.push({role: "assistant", content: response});

                                        // Update statistics
                                        statsObj.queries++;
                                        if (data.duration_ms) statsObj.time += parseFloat(data.duration_ms);
                                        if (data.usage) {
                                            statsObj.tokens += data.usage.total_tokens || 0;
                                            statsObj.cost += parseFloat(data.usage.query_cost || 0);
                                        }
                                        updateStats();

                                        // Add copy button to completed message
                                        const actionsDiv = msgDiv.querySelector('.message-actions');
                                        if (actionsDiv && response && response.trim()) {
                                            actionsDiv.innerHTML = `<button class="message-action-button" title="Copy" onclick="copyMessage(this)">${copyIcon}</button>`;
                                        }

                                        updateStatus(type, 'ready');
                                        console.log("Stream completed successfully");
                                        return;
                                    } else if (data.type === "error") {
                                        clearTimeout(timeoutWarning);
                                        contentDiv.innerHTML = `<div class="error-text"><strong>Error:</strong> ${escape(data.delta)}</div>`;
                                        updateStatus(type, 'error', 'API Error', data.delta);
                                        console.error("Stream error:", data.delta);
                                        return;
                                    }
                                }
                            } catch (e) {
                                console.error("Parse error:", e);
                            }
                        }
                    }
                }

                // Stream ended without explicit done signal
                if (!isStreamComplete) {
                    clearTimeout(timeoutWarning);
                    console.log("Stream ended without done signal, finalizing...");
                    const msgDiv = document.getElementById(msgId);
                    if (msgDiv) {
                        msgDiv.dataset.originalText = response;
                        if (!firstChunk && !response) {
                            msgDiv.querySelector('.message-content').innerHTML = "<em>[No content received]</em>";
                            updateStatus(type, 'no-content', 'No content received', 'Stream ended without content');
                        } else if (response) {
                            // Final formatting
                            const contentDiv = msgDiv.querySelector('.message-content');
                            const sqlRegex = /\b(SELECT|INSERT|UPDATE|DELETE)\b/i;
                            if (container.id === 'sql-messages' && sqlRegex.test(response)) {
                                contentDiv.innerHTML = `<pre><code class="language-sql">${escape(response)}</code></pre>`;
                                const code = contentDiv.querySelector('code.language-sql');
                                if (code && window.Prism) Prism.highlightElement(code);
                            } else if (container.id === 'general-messages' && typeof marked === 'function') {
                                contentDiv.innerHTML = marked.parse(response, {breaks: true, gfm: true});
                            } else {
                                contentDiv.innerHTML = escape(response).replace(/\n/g, '<br>');
                            }

                            // Add copy button
                            const actionsDiv = msgDiv.querySelector('.message-actions');
                            if (actionsDiv && response.trim()) {
                                actionsDiv.innerHTML = `<button class="message-action-button" title="Copy" onclick="copyMessage(this)">${copyIcon}</button>`;
                            }
                            updateStatus(type, 'ready');
                        }
                    }
                    if (historyArray && response) historyArray.push({role: "assistant", content: response});

                    statsObj.queries++;
                    statsObj.time += Date.now() - startTime;
                    updateStats();
                }

            } catch (e) {
                clearTimeout(timeoutWarning);
                console.error("Stream request failed:", e);
                const msgDiv = document.getElementById(msgId);
                if (msgDiv) {
                    msgDiv.querySelector('.message-content').innerHTML = `<div class="error-text"><strong>Error:</strong> ${escape(e.message)}</div>`;
                }

                // Determine error type
                if (e.name === 'TypeError' && e.message.includes('fetch')) {
                    updateStatus(type, 'error', 'Network Error', 'Cannot connect to server');
                } else if (e.message.includes('timeout')) {
                    updateStatus(type, 'timeout', 'Request Timeout', 'Request took too long to complete');
                } else {
                    updateStatus(type, 'error', 'Request Failed', e.message);
                }

                statsObj.queries++;
                updateStats();
            }
        }

        function updateRecent(type) {
            const list = document.getElementById(`${type}-recent`);
            const input = document.getElementById(`${type}-input`);
            const recent = stats[type].recent;

            if (!list) return;
            list.innerHTML = '';
            recent.forEach(q => {
                const li = document.createElement('li');
                li.textContent = q.length > 50 ? q.substring(0, 47) + "..." : q;
                li.title = q;
                li.onclick = () => { if (input) { input.value = q; input.focus(); } };
                list.appendChild(li);
            });
        }
    </script>
</body>
</html>